{"widgets":[
{"id":"w4", "x":10,  "y":10,"width":200,"height":80,"title":"Ref-INF","body":"","classes":"title"},
{"id":"w53","x":220, "y":10,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'REFINF_')}}","classes":"info"},
{"id":"w33","x":700, "y":10,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'REFINF_IN')}}","classes":"env"},
{"id":"w34","x":860, "y":10,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'REFINF_VA')}}","classes":"env"},
{"id":"w35","x":1020,"y":10,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'REFINF_PP')}}","classes":"env"},
{"id":"w36","x":1180,"y":10,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'REFINF_PR')}}","classes":"env"},


{"id":"w23","x":10,  "y":100,"width":200,"height":80,"title":"Ref-SEC","body":"","classes":"title"},
{"id":"w52","x":220, "y":100,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'REFSEC_')}}","classes":"info"},
{"id":"w44","x":700, "y":100,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'REFSEC_IN')}}","classes":"env"},
{"id":"w45","x":860, "y":100,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'REFSEC_VA')}}","classes":"env"},
{"id":"w46","x":1020,"y":100,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'REFSEC_PP')}}","classes":"env"},
{"id":"w47","x":1180,"y":100,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'REFSEC_PR')}}","classes":"env"},


{"id":"w23","x":10,  "y":190,"width":200,"height":80,"title":"Ref-SEC v2","body":"","classes":"title"},
{"id":"w51","x":220, "y":190,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'REFSECV2')}}","classes":"info"},
{"id":"w37","x":700, "y":190,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'REFSECV2_IN')}}","classes":"env"},
{"id":"w38","x":860, "y":190,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'REFSECV2_VA')}}","classes":"env"},
{"id":"w39","x":1020, "y":190,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'REFSECV2_PP')}}","classes":"env"},
{"id":"w40","x":1180,"y":190,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'REFSECV2_PR')}}","classes":"env"},


{"id":"w3", "x":10,  "y":280,"width":200,"height":80,"title":"RCPers/W","body":"","classes":"title"},
{"id":"w2", "x":700, "y":280,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'RCPERS_IN_WEST')}}","classes":"env"},
{"id":"w11","x":860, "y":280,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'RCPERS_VA_WEST')}}","classes":"env"},
{"id":"w12","x":1020, "y":280,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'RCPERS_PP_WEST')}}","classes":"env"},
{"id":"w13","x":1180,"y":280,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'RCPERS_PR_WEST')}}","classes":"env"},

{"id":"w0", "x":10,  "y":370,"width":200,"height":80,"title":"Siti","body":"","classes":"title"},
{"id":"w50","x":220, "y":370,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'SITI')}}","classes":"info"},
{"id":"w20","x":540, "y":370,"width":150,"height":80,"title":"DE","body":"{{buildEnv(cv, widget, 'SITI_DE_CORE')}}","classes":"env"},
{"id":"w2", "x":700, "y":370,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'SITI_IN_CORE')}}","classes":"env"},
{"id":"w11","x":860, "y":370,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'SITI_VA_CORE')}}","classes":"env"},
{"id":"w12","x":1020,"y":370,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'SITI_PP_CORE')}}","classes":"env"},
{"id":"w13","x":1180,"y":370,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'SITI_PR_CORE')}}","classes":"env"},


{"id":"w25","x":10,  "y":460,"width":200,"height":80,"title":"RMP","body":"","classes":"title"},
{"id":"w49","x":220, "y":460,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'RMP')}}","classes":"info"},
{"id":"w41","x":700, "y":460,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'RMP_IN')}}","classes":"env"},
{"id":"w42","x":860, "y":460,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'RMP_VA')}}","classes":"env"},
{"id":"w43","x":1180,"y":460,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'RMP_PR')}}","classes":"env"},


{"id":"w26","x":10,  "y":550,"width":200,"height":80,"title":"ATEV-BO","body":"","classes":"title"},
{"id":"w54","x":700, "y":550,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'ATEV_BO_IN')}}","classes":"env"},
{"id":"w55","x":860, "y":550,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'ATEV_BO_VA')}}","classes":"env"},
{"id":"w56","x":1180,"y":550,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'ATEV_BO_PR')}}","classes":"env"},


{"id":"w8", "x":10,  "y":640,"width":200,"height":80,"title":"RCEnt","body":"","classes":"title"},
{"id":"w19","x":220, "y":640,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'RCENT')}}","classes":"info"},
{"id":"w1", "x":380, "y":640,"width":150,"height":80,"title":"SB","body":"{{buildEnv(cv, widget, 'RCENT_SB')}}","classes":"env"},
{"id":"w5", "x":540, "y":640,"width":150,"height":80,"title":"TE","body":"{{buildEnv(cv, widget, 'RCENT_TE')}}","classes":"env"},
{"id":"w6", "x":700, "y":640,"width":150,"height":80,"title":"I2","body":"{{buildEnv(cv, widget, 'RCENT_I2')}}","classes":"env"},
{"id":"w7", "x":860, "y":640,"width":150,"height":80,"title":"VA2","body":"{{buildEnv(cv, widget, 'RCENT_VA')}}","classes":"env"},
{"id":"w9", "x":1020, "y":640,"width":150,"height":80,"title":"PP2","body":"{{buildEnv(cv, widget, 'RCENT_PP2')}}","classes":"env"},
{"id":"w10","x":1180,"y":640,"width":150,"height":80,"title":"PR2","body":"{{buildEnv(cv, widget, 'RCENT_PR2')}}","classes":"env"},


{"id":"w27","x":10,  "y":730,"width":200,"height":80,"title":"Transverse","body":"","classes":"title"},
{"id":"w32","x":220, "y":730,"width":150,"height":80,"title":"Mtrd/Tom","body":"{{cv('MITARD_STATUS').value}}","classes":"env"},
{"id":"w30","x":380, "y":730,"width":150,"height":80,"title":"","body":"{{buildFicheLivraisonRCEnt(cv, widget)}}","classes":"env"},
{"id":"w31","x":540, "y":730,"width":150,"height":80,"title":"","body":"","classes":"env"},
{"id":"w48","x":700, "y":730,"width":150,"height":80,"title":"Sonar","body":"{{cv('SONAR_STATUS').value}}","classes":"env"},
{"id":"w48","x":860, "y":730,"width":150,"height":80,"title":"Jenkins","body":"{{cv('JENKINS_STATUS').value}}","classes":"env"},
{"id":"w28","x":1020, "y":730,"width":150,"height":80,"title":"IDE-TEST","body":"{{cv('IDE_TEST_ERR').value}}","classes":"env"},
{"id":"w29","x":1180,"y":730,"width":150,"height":80,"title":"IDE-PR","body":"{{cv('IDE_PR_ERR').value}}","classes":"env"},




{"id":"w18","x":1340,"y":10,"width":330,"height":180,"title":"Bureau","body": "{{buildMeteoBureau(cv)}}","classes":"whitebox bureau notitle"},
{"id":"w16","x":1340,"y":200,"width":332,"height":170,"title":"Météo","body":"{{buildMeteo(cv)}}","classes":"whitebox meteo notitle"},
{"id":"w16","x":1340,"y":380,"width":332,"height":250,"title":"Webcam","body":"<a href='http://tom.etat-de-vaud.ch/meteocamsud.jpg'><img src='http://tom.etat-de-vaud.ch/meteocamsud.jpg' style='width:100%'></a>","classes":"webcam notitle"},
{"id":"w15","x":1340,"y":640,"width":334,"height":70,"title":"TIME","body":"#TIME#<span id='date'>#DATE#</span>","classes":"whitebox time notitle"},
{"id":"w17","x":1340,"y":720,"width":334,"height":250,"title":"Menu","body":"{{buildMenu(cv)}}","classes":"whitebox menu notitle"},

{"id":"w57","x":220,"y":820,"width":340,"height":70,"title":"RCEnt/DB PR2","body":"<table><tr><th>Dernier eve traité:</th><td>{{cv('RCENT_PR_LAST_TRAITE').value}}</td></tr><tr><th>Dernier eve en erreur:</th><td>{{cv('RCENT_PR_LAST_EN_ERREUR').value}}</td></tr></table>","classes":"whitebox"},
{"id":"w58","x":570,"y":820,"width":340,"height":70,"title":"RCEnt/Refact/Env-TE","body":"{{buildRefact(cv,'RCENT')}}","classes":"whitebox refact"},
{"id":"w58","x":570,"y":900,"width":340,"height":70,"title":"RCEnt/RCEnt-acceptance-tests/Env-I2","body":"{{buildRefact(cv,'RCENT2')}}","classes":"whitebox refact"},
{"id":"w58","x":920,"y":820,"width":340,"height":70,"title":"Siti/Siti-acceptance-tests/Env-IN","body":"{{buildRefact(cv,'SITI2')}}","classes":"whitebox refact"},

{"id":"w59","x":220,"y":900,"width":340,"height":80,"title":"Server","body":"{{buildCopperStatus(cv, widget, copperStatus)}}","classes":"env"}

],
"css": [
".whitebox {",
"    background: white;",
"    border: 3px solid #acd7e5;",
"    border-radius: 10px;",
"    color: #3537ff;",
"}",
"",
".notitle .box-title {",
"    visibility:hidden;",
"    margin: 0px;",
"    height: 0px;",
"}",
"",
".title {",
"    background: #157;",
"    border-radius: 10px;",
"    border: 1px outset #678;",
"    text-align:center;",
"}",
"",
".title .box-title {",
"    background: #157;",
"    color: white;",
"    border: 0px;",
"    border-radius: 10px;",
"    font-size: 32px;",
"    padding-top: 22px;",
"    text-shadow: 1px 1px 0 #999;",
"}",
"",
".time {",
"    font-size: 54px;",
"    font-weight: bolder;",
"    text-align: center;",
"}",
".time span#date {",
"    position:absolute;",
"    top:  2px;",
"    left: 2px;",
"    font-size: 12px;",
"    font-weight: normal;",
"}",
"",
".env {",
"    background: #0c7f00;",
"    color: white;",
"    border-radius: 10px;",
"    border: 1px solid darkslategrey;",
"    text-align:center;",
"}",
"",
".env_ko {",
"    background: #8b0000 !important;",
"    border: 1px solid darkred !important;",
"}",
"",
".env_ko .box-title { ",
"    background: #8b0000 !important;",
"}",
"",
".env_ko .box-body { ",
"    background: #8b0000 !important;",
"}",
"",
".env .box-title {",
"    background: #0c7f00;",
"    border: 0px;",
"    border-radius: 10px;",
"    color: white;",
"    font-size: 32px;",
"    padding-top: 20px;",
"}",
"",
".env .box-body {",
"    padding-top: 8px;",
"    color: lightgrey;",
"    font-size: 13px;",
"    font-style: italic;",
"}",
"",
".info {",
"    background: white;",
"    border: 0px;",
"    border-radius: 10px;",
"    color: black;",
"    font-size: 10px;",
"}",
"",
".info .box-title {",
"    height: 0px;",
"    visibility:hidden;",
"}",
"",
".info .box-body {",
"    padding-top: 8px;",
"    padding-left: 10px;",
"}",
"",
".bureau {",
"    text-align:center;",
"    font-size: 28px;",
"}",
"#bureau_temp {",
"    font-size: 86px;",
"    font-weight:bolder;",
"    color: orange",
"}",
".meteo {",
"    text-align:center;",
"}",
".meteo_title {",
"    font-size: 28px;",
"}",
".meteo_body {",
"}",
".menu {",
"    text-align:center;",
"}",
".menu .menu_title {",
"    font-size: 28px;",
"    font-family:serif;",
"}",
".menu12_title {",
"    font-weight:bolder;",
"    padding-right: 10px;",
"}",
".menu12_corps {",
"    font-size: 12px;",
"}",
".menu12_prix {",
"    font-size: 12px;",
"}",
".statusMin{",
"    color: lightgreen;",
"    position:absolute;",
"    top: 3px;",
"    right: 4px;",
"    font-size: 10px",
"}",
".refact .box-body{",
"    font-size: 12px",
"}",
""],


"script":[
"buildRefact = function(cv, app) {",
"   var data = cv(app+'_REFACT_SUMMARY').value;",
"   return data;",
"}",
"buildMeteoBureau = function(cv) {",
"    var temp = cv('METEO_P02_157_TEMPER').value;",
"    var hum = cv('METEO_P02_157_HUMIDITY').value;",
"    var html='<span id=\"bureau_title\">Bureau</span><br/><span id=\"bureau_temp\">' + temp + '</span><br/><span id=+\"bureau_hum\">';",
"    html+='Hum: ' + hum + '</span>&nbsp;<span id=\"bureau_idx\">Idx:' + calcHumidex(temp, hum) + '</span>';",
"    return html;",
"}",
"buildMeteo = function(cv) {",
"   var data = cv('WEATHER').value;",
"   data = JSON.parse(data);",
"   var humidex=calcHumidex(data.main.temp, data.main.humidity);",
"   var html='';",
"   html+='<span class=\"meteo_title\">RENENS</span><br/>';",
"   html+='<span class=\"meteo_body\">' + data.main.temp + '°C / ' + data.main.humidity + '% </span> / humidex=' + humidex + '<br/>';",
"   html+='<span class=\"meteo_body\">Vis. ' + data.visibility + 'm / Nuages ' + data.clouds.all + '% / vent ' + data.wind.speed + 'km/h</span><br/>';",
"   html+='<span class=\"meteo_body\">' + data.weather[0].description + '</span><br/>';",
"   // TODOsunset, sunrise ",
"   return html",
"}",
"",
"buildMenu = function(cv) { ",
"   var data = cv('CAFET').value;",
"   data = JSON.parse(data);",
"   //var html='Menu, semaine du ' + data[0].dateDebut;",
"   var date = new Date();",
"   var dateJour=(date.getDate()<10?'0':'') + date.getDate() + '.' + (date.getMonth()<9?'0':'') + (date.getMonth()+1) +'.'+date.getFullYear();",
"   var menuObj = data[0].jours.filter(j=>j.dateJour==dateJour);",
"   var html = '<span class=\"menu_title\">Menu du ' + dateJour + '</span><br/><br/>';",
"   if (menuObj==null || menuObj.length==0) { return html + '(Pas de données)'; }",
"   html+='<span class=\"menu12_title\">' + menuObj[0].menus[0].titreFr + '</span>';",
"   html+='<span class=\"menu12_prix\">(' + menuObj[0].menus[0].prix1 + ' CHF)</span><br/>';",
"   html+='<span class=\"menu12_corps\">' + menuObj[0].menus[0].corpsFr.replace('\\n','<br/>') + '</span><br/><br/>';",
"   html+='<span class=\"menu12_title\">' + menuObj[0].menus[1].titreFr + '</span>';",
"   html+='<span class=\"menu12_prix\">(' + menuObj[0].menus[1].prix1 + ' CHF)</span><br/>';",
"   html+='<span class=\"menu12_corps\">' + menuObj[0].menus[1].corpsFr.replace('\\n','<br/>') + '</span>';",
"   //var menuObj = data.menu.filter(j=>j.date==dateJour);",
"   //var html = '<span class=\"menu_title\">Menu du ' + dateJour + '</span><br/><br/>';",
"   //html+='<span class=\"menu12_title\">' + menuObj.menu1 + '</span>';",
"   //html+='<span class=\"menu12_title\">' + menuObj.menu2 + '</span>';",
"   return html;",
"}",
"",
"buildCopperStatus = function(cv, widget, status) {",
"   widget.classes=widget.classes.replace(' env_ko ', '');",
"   if(status!='OK') {",
"      widget.classes+=' env_ko ';",
"   }",
"   return '<span title=\"' + status + '\">' + status + '</span>';",
"}",
"",
"buildEnv = function(cv, widget, id) {",
"   //console.log('buildEnv1 ', widget, id);",
"   var version = cv(id+'_VERSION').value;",
"   var status = cv(id+'_STATUS').value;",
"   status = status.replace(/Nexus.*/,'');",
"   var tsFromStatus = cv(id+'_STATUS').timestampFrom;",
"   //console.log('buildEnv2 ', widget, version, status);",
"      widget.classes=widget.classes.replace(' env_ko ', '');",
"   if (status==null) {",
"      widget.classes+=' env_ko ';",
"   } else if (status.substr(0,2)=='OK') {",
"      // ok ",
"   } else if (status.substr(0,2)=='KO' || status.substr(0,2)=='Ko') {",
"      widget.classes+=' env_ko ';",
"   } else if (status.indexOf('KO')>-1) {",
"      widget.classes+=' env_ko ';",
"   } else if (status.indexOf('404')>-1) {",
"      widget.classes+=' env_ko ';",
"   } else if (status=='?') {",
"      widget.classes+=' env_ko ';",
"   } else if (status=='') {",
"      widget.classes+=' env_ko ';",
"   }",
"   ",
"   var statusMin=Math.floor((new Date() - Date.parse(tsFromStatus))/1000/60);",
"   return '<span title=\"' + status + '\">' + version + '</span><span class=\"statusMin\" title=\"Last status changed at ' + tsFromStatus + ': ' + statusMin + ' minutes ago.\">' + statusMin + '</span>';",
"}",
"",
"buildFicheLivraisonRCEnt = function(cv, widget) {",
"   var data = cv('JENKINS_VALUES').value;",
"   var status='red';",
"   widget.classes=widget.classes.replace(' env_ko ', '');",
"   for (var i=0; i<jobs.length; i++) {",
"      var job = jobs[i];",
"      var jobNameLC = job.name.toLowerCase();",
"      if (jobNameLC=='rcent-dev-fiches') {",
"         status=job.color;",
"      }",
"   }",
"   var s='<span title=\"FL\" style=\"font-size:32px; font-weight:bold;\">FL</span>&nbsp;';",
"   if (status=='red') {",
"      s+='KO';",
"      widget.classes+=' env_ko ';",
"   } else if (status=='yellow') {",
"      s+='Warn: ' + yellow.length + '  ';",
"      widget.classes+=' env_ko ';",
"   } else {",
"      s+='OK';",
"   }",
"   return s;",
"}",
"",
"buildJenkins = function(cv, widget, id) {",
"   var data = cv('JENKINS_VALUES').value;",
"   jobs = JSON.parse(data).jobs;",
"   var red=[];",
"   var yellow=[];",
"   widget.classes=widget.classes.replace(' env_ko ', '');",
"   for (var i=0; i<jobs.length; i++) {",
"      var job = jobs[i];",
"      var jobNameLC = job.name.toLowerCase();",
"      if (jobNameLC.endsWith('_mon') && jobNameLC.indexOf(id.toLowerCase())==0 && job.color!='notbuilt' && job.color!='disabled') {",
"         if (job.color=='red') red.push(job);",
"         if (job.color=='yellow') yellow.push(job);",
"      }",
"   }",
"   var s='<span title=\"KO=' + red.map(e=>e.name).join(\",\") + ', Warn=' + yellow.map(e=>e.name).join(\",\") + '\">&xodot;</span>&nbsp;';",
"   if (red.length>0) {",
"      s+='KO: ' + red.length + '  ';",
"      widget.classes+=' env_ko ';",
"   }",
"   if (yellow.length>0) {",
"      s+='Warn: ' + yellow.length + '  ';",
"      widget.classes+=' env_ko ';",
"   }",
"   return s;",
"}",
"",
"",
"function evaluateXPath(aNode, aExpr) {",
"  var xpe = new XPathEvaluator();",
"  var nsResolver = xpe.createNSResolver(aNode.ownerDocument == null ?",
"    aNode.documentElement : aNode.ownerDocument.documentElement);",
"  var result = xpe.evaluate(aExpr, aNode, nsResolver, 0, null);",
"  var found = [];",
"  var res;",
"  while (res = result.iterateNext())",
"    found.push(res);",
"  return found;",
"}",
"function calcHumidex(t_celcius, humidite) {",
"   var valueInt = parseInt(t_celcius);",
"   t_celcius = parseFloat(t_celcius);",
"   humidite = parseFloat(humidite);",
"   var t_kelvin=t_celcius + 273;",
"   var eTs=Math.pow(10,((-2937.4 /t_kelvin)-4.9283* Math.log(t_kelvin)/Math.LN10 +23.5471));",
"   var eTd=eTs * humidite /100;",
"   humidex=Math.round((t_celcius + ((eTd-10)*5/9))*10)/10;",
"   if (humidex < t_celcius) { humidex=t_celcius; }",
"   //console.log('calcHumidex', t_celcius, humidite, humidex, t_kelvin, valueInt, eTs, eTd);",
"   return humidex;",
"}",
""]
}
