{"widgets":[
    {"id":"w4", "x":10,  "y":10,"width":250,"height":80,"title":"SiTi-Core","body":"","classes":"title"},
    {"id":"w53","x":270, "y":10,"width":150,"height":80,"title":"Builds","body":"{{buildJenkins(cv, widget, 'SITI')}}","classes":"jenkins"},
    {"id":"w20","x":590, "y":10,"width":150,"height":80,"title":"DE","body":"{{buildEnv(cv, widget, 'SITI_DE_CORE')}}","classes":"env"},
    {"id":"w33","x":750, "y":10,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'SITI_IN_CORE')}}","classes":"env"},
    {"id":"w34","x":910, "y":10,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'SITI_VA_CORE')}}","classes":"env"},
    {"id":"w35","x":1070,"y":10,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'SITI_PP_CORE')}}","classes":"env"},
    {"id":"w36","x":1230,"y":10,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'SITI_PR_CORE')}}","classes":"env"},

    {"id":"w23","x":10,  "y":100,"width":250,"height":80,"title":"SiTi-Solr","body":"","classes":"title"},
    {"id":"w20","x":590, "y":100,"width":150,"height":80,"title":"DE","body":"{{buildEnvSolr(cv, widget, 'SITI_DE_SOLR')}}","classes":"env"},
    {"id":"w44","x":750, "y":100,"width":150,"height":80,"title":"IN","body":"{{buildEnvSolr(cv, widget, 'SITI_IN_SOLR')}}","classes":"env"},
    {"id":"w45","x":910, "y":100,"width":150,"height":80,"title":"VA","body":"{{buildEnvSolr(cv, widget, 'SITI_VA_SOLR')}}","classes":"env"},
    {"id":"w46","x":1070,"y":100,"width":150,"height":80,"title":"PP","body":"{{buildEnvSolr(cv, widget, 'SITI_PP_SOLR')}}","classes":"env"},
    {"id":"w47","x":1230,"y":100,"width":150,"height":80,"title":"PR","body":"{{buildEnvSolr(cv, widget, 'SITI_PR_SOLR')}}","classes":"env"},

    {"id":"w3", "x":10,  "y":190,"width":250,"height":80,"title":"RCPers-West","body":"","classes":"title"},
    {"id":"w2", "x":750, "y":190,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'RCPERS_IN_WEST')}}","classes":"env"},
    {"id":"w11","x":910, "y":190,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'RCPERS_VA_WEST')}}","classes":"env"},
    {"id":"w12","x":1070, "y":190,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'RCPERS_PP_WEST')}}","classes":"env"},
    {"id":"w13","x":1230,"y":190,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'RCPERS_PR_WEST')}}","classes":"env"},

    {"id":"w8", "x":10,  "y":280,"width":250,"height":80,"title":"RCEnt","body":"","classes":"title"},
    {"id":"w1", "x":430, "y":280,"width":150,"height":80,"title":"SB","body":"{{buildEnv(cv, widget, 'RCENT_SB')}}","classes":"env"},
    {"id":"w5", "x":590, "y":280,"width":150,"height":80,"title":"TE","body":"{{buildEnv(cv, widget, 'RCENT_TE')}}","classes":"env"},
    {"id":"w6", "x":750, "y":280,"width":150,"height":80,"title":"I2","body":"{{buildEnv(cv, widget, 'RCENT_I2')}}","classes":"env"},
    {"id":"w7", "x":910, "y":280,"width":150,"height":80,"title":"VA2","body":"{{buildEnv(cv, widget, 'RCENT_VA')}}","classes":"env"},
    {"id":"w9", "x":1070, "y":280,"width":150,"height":80,"title":"PP2","body":"{{buildEnv(cv, widget, 'RCENT_PP2')}}","classes":"env"},
    {"id":"w10","x":1230,"y":280,"width":150,"height":80,"title":"PR2","body":"{{buildEnv(cv, widget, 'RCENT_PR2')}}","classes":"env"},

    {"id":"w23","x":10,  "y":370,"width":250,"height":80,"title":"Ref-SEC","body":"","classes":"title"},
    {"id":"w44","x":750, "y":370,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'REFSEC_IN')}}","classes":"env"},
    {"id":"w45","x":910, "y":370,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'REFSEC_VA')}}","classes":"env"},
    {"id":"w46","x":1070,"y":370,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'REFSEC_PP')}}","classes":"env"},
    {"id":"w47","x":1230,"y":370,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'REFSEC_PR')}}","classes":"env"},

    {"id":"w23","x":10,  "y":460,"width":250,"height":80,"title":"Ref-SEC v2","body":"","classes":"title"},
    {"id":"w37","x":750, "y":460,"width":150,"height":80,"title":"IN","body":"{{buildEnv(cv, widget, 'REFSECV2_IN')}}","classes":"env"},
    {"id":"w38","x":910, "y":460,"width":150,"height":80,"title":"VA","body":"{{buildEnv(cv, widget, 'REFSECV2_VA')}}","classes":"env"},
    {"id":"w39","x":1070, "y":460,"width":150,"height":80,"title":"PP","body":"{{buildEnv(cv, widget, 'REFSECV2_PP')}}","classes":"env"},
    {"id":"w40","x":1230,"y":460,"width":150,"height":80,"title":"PR","body":"{{buildEnv(cv, widget, 'REFSECV2_PR')}}","classes":"env"},

    {"id":"w27","x":10,  "y":550,"width":250,"height":80,"title":"Transverse","body":"","classes":"title"},
    {"id":"w48","x":270, "y":550,"width":150,"height":80,"title":"Sonar","body":"{{cv('SONAR_STATUS').value}}","classes":"env"},
    {"id":"w48","x":430, "y":550,"width":150,"height":80,"title":"Jenkins","body":"{{cv('JENKINS_STATUS').value}}","classes":"env"}

],
    "css": [
        ".whitebox {",
        "    background: white;",
        "    border: 3px solid #acd7e5;",
        "    border-radius: 10px;",
        "    color: #3537ff;",
        "}",
        "",
        ".notitle .box-title {",
        "    visibility:hidden;",
        "    margin: 0px;",
        "    height: 0px;",
        "}",
        "",
        ".title {",
        "    background: #157;",
        "    border-radius: 10px;",
        "    border: 1px outset #678;",
        "    text-align:center;",
        "}",
        "",
        ".title .box-title {",
        "    background: #157;",
        "    color: white;",
        "    border: 0px;",
        "    border-radius: 10px;",
        "    font-size: 32px;",
        "    padding-top: 22px;",
        "    text-shadow: 1px 1px 0 #999;",
        "}",
        "",
        ".time {",
        "    font-size: 54px;",
        "    font-weight: bolder;",
        "    text-align: center;",
        "}",
        ".time span#date {",
        "    position:absolute;",
        "    top:  2px;",
        "    left: 2px;",
        "    font-size: 12px;",
        "    font-weight: normal;",
        "}",
        "",
        ".env {",
        "    background: #0c7f00;",
        "    color: white;",
        "    border-radius: 10px;",
        "    border: 1px solid darkslategrey;",
        "    text-align:center;",
        "}",
        "",
        ".env_ko {",
        "    background: #8b0000 !important;",
        "    border: 1px solid darkred !important;",
        "}",
        "",
        ".env_ko .box-title { ",
        "    background: #8b0000 !important;",
        "}",
        "",
        ".env_ko .box-body { ",
        "    background: #8b0000 !important;",
        "}",
        "",
        ".env .box-title {",
        "    background: #0c7f00;",
        "    border: 0px;",
        "    border-radius: 10px;",
        "    color: white;",
        "    font-size: 32px;",
        "    padding-top: 20px;",
        "}",
        "",
        ".env .box-body {",
        "    padding-top: 8px;",
        "    color: lightgrey;",
        "    font-size: 13px;",
        "    font-style: italic;",
        "}",
        "",
        ".info {",
        "    background: white;",
        "    border: 0px;",
        "    border-radius: 10px;",
        "    color: black;",
        "    font-size: 10px;",
        "}",
        "",
        ".info .box-title {",
        "    height: 0px;",
        "    visibility:hidden;",
        "}",
        "",
        ".info .box-body {",
        "    padding-top: 8px;",
        "    padding-left: 10px;",
        "}",
        "",
        ".jenkins {",
        "    background: #0c7f00;",
        "    color: white;",
        "    border-radius: 10px;",
        "    border: 1px solid darkslategrey;",
        "}",
        "",
        ".jenkins .box-title {",
        "    height: 0px;",
        "    visibility:hidden;",
        "}",
        "",
        ".jenkins .box-body {",
        "    padding-top: 8px;",
        "    padding-left: 10px;",
        "}",
        "",
        ".bureau {",
        "    text-align:center;",
        "    font-size: 28px;",
        "}",
        "#bureau_temp {",
        "    font-size: 86px;",
        "    font-weight:bolder;",
        "    color: orange",
        "}",
        ".meteo {",
        "    text-align:center;",
        "}",
        ".meteo_title {",
        "    font-size: 28px;",
        "}",
        ".meteo_body {",
        "}",
        ".menu {",
        "    text-align:center;",
        "}",
        ".menu .menu_title {",
        "    font-size: 28px;",
        "    font-family:serif;",
        "}",
        ".menu12_title {",
        "    font-weight:bolder;",
        "    padding-right: 10px;",
        "}",
        ".menu12_corps {",
        "    font-size: 12px;",
        "}",
        ".menu12_prix {",
        "    font-size: 12px;",
        "}",
        ".statusMin{",
        "    color: lightgreen;",
        "    position:absolute;",
        "    top: 3px;",
        "    right: 4px;",
        "    font-size: 10px",
        "}",
        ""],


    "script":[
        "buildMeteo = function(cv) {",
        "   var data = cv('WEATHER').value;",
        "   data = JSON.parse(data);",
        "   var humidex=calcHumidex(data.main.temp, data.main.humidity);",
        "   var html='';",
        "   html+='<span class=\"meteo_title\">RENENS</span><br/>';",
        "   html+='<span class=\"meteo_body\">' + data.main.temp + 'Â°C / ' + data.main.humidity + '% </span> / humidex=' + humidex + '<br/>';",
        "   html+='<span class=\"meteo_body\">Vis. ' + data.visibility + 'm / Nuages ' + data.clouds.all + '% / vent ' + data.wind.speed + 'km/h</span><br/>';",
        "   html+='<span class=\"meteo_body\">' + data.weather[0].description + '</span><br/>';",
        "   // TODOsunset, sunrise ",
        "   return html",
        "}",
        "",
        "buildMenu = function(cv) { ",
        "   var data = cv('CAFET').value;",
        "   data = JSON.parse(data);",
        "   //var html='Menu, semaine du ' + data[0].dateDebut;",
        "   var date = new Date();",
        "   var dateJour=(date.getDate()<10?'0':'') + date.getDate() + '.' + (date.getMonth()<9?'0':'') + (date.getMonth()+1) +'.'+date.getFullYear();",
        "   //console.log('CAFET', data);",
        "   var menuObj = data[0].jours.filter(j=>j.dateJour==dateJour);",
        "   var html = '<span class=\"menu_title\">Menu du ' + dateJour + '</span><br/><br/>';",
        "   html+='<span class=\"menu12_title\">' + menuObj[0].menus[0].titreFr + '</span>';",
        "   html+='<span class=\"menu12_prix\">(' + menuObj[0].menus[0].prix1 + ' CHF)</span><br/>';",
        "   html+='<span class=\"menu12_corps\">' + menuObj[0].menus[0].corpsFr.replace('\\n','<br/>') + '</span><br/><br/>';",
        "   html+='<span class=\"menu12_title\">' + menuObj[0].menus[1].titreFr + '</span>';",
        "   html+='<span class=\"menu12_prix\">(' + menuObj[0].menus[1].prix1 + ' CHF)</span><br/>';",
        "   html+='<span class=\"menu12_corps\">' + menuObj[0].menus[1].corpsFr.replace('\\n','<br/>') + '</span>';",
        "   //var menuObj = data.menu.filter(j=>j.date==dateJour);",
        "   //var html = '<span class=\"menu_title\">Menu du ' + dateJour + '</span><br/><br/>';",
        "   //html+='<span class=\"menu12_title\">' + menuObj.menu1 + '</span>';",
        "   //html+='<span class=\"menu12_title\">' + menuObj.menu2 + '</span>';",
        "   return html;",
        "}",
        "",
        "buildEnv = function(cv, widget, id) {",
        "   var version = cv(id+'_VERSION').value;",
        "   var status = cv(id+'_STATUS').value;",
        "   var tsFromStatus = cv(id+'_STATUS').timestampFrom;",
        "   widget.classes=widget.classes.replace(' env_ko ', '');",
        "   if (isStatusKO(status)) {",
        "      widget.classes+=' env_ko ';",
        "   }",
        "   ",
        "   var statusMin=Math.floor((new Date() - Date.parse(tsFromStatus))/1000/60);",
        "   return '<span title=\"' + status + '\">' + version + '</span><span class=\"statusMin\" title=\"Last status changed at ' + tsFromStatus + ': ' + statusMin + ' minutes ago.\">' + statusMin + '</span>';",
        "}",
        "",
        "buildEnvSolr = function(cv, widget, id) {",
        "   var version = cv(id+'_VERSION').value;",
        "   var status = cv(id+'_STATUS').value;",
        "   var statusStat = cv(id+'_STAT_STATUS').value;",
        "   var tsFromStatus = cv(id+'_STATUS').timestampFrom;",
        "   widget.classes = widget.classes.replace(' env_ko ', '');",
        "   var titleSpan = titleSolr(cv,id,status);",
        "   if (isStatusKO(status)) {",
        "      widget.classes+=' env_ko ';",
        "   } else if (isStatusKO(statusStat)) {",
        "      widget.classes+=' env_ko ';",
        "      titleSpan = titleSolr(cv,id,statusStat);",
        "   }",
        "   ",
        "   var statusMin=Math.floor((new Date() - Date.parse(tsFromStatus))/1000/60);",
        "   return '<span title=\"' + titleSpan + '\">' + version + '</span><span class=\"statusMin\" title=\"Last status changed at ' + tsFromStatus + ': ' + statusMin + ' minutes ago.\">' + statusMin + '</span>';",
        "}",
        "",
        "buildJenkins = function(cv, widget, id) {",
        "   var data = cv('JENKINS_VALUES').value;",
        "   jobs = JSON.parse(data).jobs;",
        "   var red=[];",
        "   var yellow=[];",
        "   for (var i=0; i<jobs.length; i++) {",
        "      var job = jobs[i];",
        "      var jobNameLC = job.name.toLowerCase();",
        "      if (jobNameLC.endsWith('_mon') && jobNameLC.indexOf(id.toLowerCase())==0 && job.color!='notbuilt' && job.color!='disabled') {",
        "         if (job.color=='red') red.push(job);",
        "         if (job.color=='yellow') yellow.push(job);",
        "      }",
        "   }",
        "  if(red.length>0 || yellow.length>0) {",
        "     widget.classes+=' env_ko ';",
        "   }",
        "   var s='<span title=\"KO=' + red.map(e=>e.name).join(\",\") + '\">&xodot;</span>&nbsp;';",
        "   s+='KO: ' + red.length + '<br><br>';",
        "   s+='<span title=\"Warn=' + yellow.map(e=>e.name).join(\",\") + '\">&xodot;</span>&nbsp;';",
        "   s+='Warn: ' + yellow.length;",
        "   return s;",
        "}",
        "",
        "function isStatusKO(status) {",
        "   return status==null || status.toLowerCase().substr(0,2)=='ko' || status.toLowerCase().indexOf('ko:')>-1 || status.indexOf('404')>-1;",
        "}",
        "function titleSolr(cv,id,status) {",
        "   var totalDoc = cv(id+'_STAT_TOTAL').value;",
        "   var nbPers = cv(id+'_STAT_NBPERS').value;",
        "   var nbOrg = cv(id+'_STAT_NBORG').value;",
        "   return 'Status:'+status+'&#10;TotalDoc:'+totalDoc+'&#10;NbPers:'+nbPers+'&#10;NbOrg:'+nbOrg;",
        "}",
        ""]
}
